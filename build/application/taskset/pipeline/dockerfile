from golang:1.16.4 as builder
WORKDIR /app
COPY ./ ./

ENV GOPATH /go
ENV CGO_ENABLED 0
ENV GO111MODULE on
ENV GOPROXY=https://goproxy.cn,direct

RUN make pipeline_build binary_dir="/app/server/bin"

FROM alpine
WORKDIR /app
COPY --from=builder /app/server/bin/pipeline /app/pipeline
RUN chmod +x /app/pipeline
EXPOSE 7001

ENTRYPOINT ["/app/pipeline"]